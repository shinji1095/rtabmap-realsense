# RTAB-SLAM-DOCKER
Dockerç’°å¢ƒã§ROS2ã‚’ä½¿ã„,RTAB-SLAMã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã§ã™ï¼
Windowsä¸Šã§WSL2ä¸Šã«Dockerã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ã„ã‚‹ã“ã¨ã‚’å‰æã«ã—ã¦ã„ã¾ã™ï¼

# ç›®æ¬¡

- [RTAB-SLAM-DOCKER](#rtab-slam-docker)
- [ç›®æ¬¡](#ç›®æ¬¡)
- [1. å®Ÿè¡Œç’°å¢ƒ](#1-å®Ÿè¡Œç’°å¢ƒ)
- [2. ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸æ¦‚è¦](#2-ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸æ¦‚è¦)
  - [2.1 ãƒ•ã‚©ãƒ«ãƒ€æ§‹æˆ](#21-ãƒ•ã‚©ãƒ«ãƒ€æ§‹æˆ)
  - [2.2 ãƒ•ã‚©ãƒ«ãƒ€èª¬æ˜](#22-ãƒ•ã‚©ãƒ«ãƒ€èª¬æ˜)
- [3. WSL2ç’°å¢ƒè¨­å®š](#3-wsl2ç’°å¢ƒè¨­å®š)
- [4. Dockerã‚³ãƒ³ãƒ†ãƒŠã®æ“ä½œ](#4-dockerã‚³ãƒ³ãƒ†ãƒŠã®æ“ä½œ)
- [5. ãƒ‡ãƒ¼ã‚¿åé›†](#5-ãƒ‡ãƒ¼ã‚¿åé›†)
  - [5.1 å‰æº–å‚™](#51-å‰æº–å‚™)
  - [5.2 ãƒ‡ãƒ¼ã‚¿åé›†æ‰‹é †](#52-ãƒ‡ãƒ¼ã‚¿åé›†æ‰‹é †)
- [6. è»Œè·¡ã®è¨˜éŒ²ã¨å¯è¦–åŒ–](#6-è»Œè·¡ã®è¨˜éŒ²ã¨å¯è¦–åŒ–)
- [7. VSCodeè¨­å®š](#7-vscodeè¨­å®š)
  - [7.1 WSLã«æ¥ç¶š](#71-wslã«æ¥ç¶š)
  - [7.2 Dockerã‚³ãƒ³ãƒ†ãƒŠã‚’ã‚¢ã‚¿ãƒƒãƒ](#72-dockerã‚³ãƒ³ãƒ†ãƒŠã‚’ã‚¢ã‚¿ãƒƒãƒ)
  - [7.3 ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é–‹ã](#73-ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é–‹ã)
- [âœ…TODO](#todo)
- [ğŸ“’å‚è€ƒæ–‡çŒ®](#å‚è€ƒæ–‡çŒ®)

# 1. å®Ÿè¡Œç’°å¢ƒ

| ç’°å¢ƒ | ãƒãƒ¼ã‚¸ãƒ§ãƒ³ |
| ---- | ---- |
| Host OS | Windows 11 Home |
| Gest OS | Ubuntu 22.04 LTE |
| WSL2 | TBD |
| Docker | TBD |
| Base Image | ros:humble-perception |
| ROS | ROS 2 Humble |

# 2. ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸æ¦‚è¦

## 2.1 ãƒ•ã‚©ãƒ«ãƒ€æ§‹æˆ

```shell
â”œâ”€â”€ config/
â”œâ”€â”€ docker/
    â”œâ”€â”€ Dockerfile
    â””â”€â”€ docker-compose.yaml
â”œâ”€â”€ img/
â”œâ”€â”€ src/
    â””â”€â”€ scripts
â”œâ”€â”€ volume/
â””â”€â”€ README.md
```

## 2.2 ãƒ•ã‚©ãƒ«ãƒ€èª¬æ˜

| ãƒ•ã‚©ãƒ«ãƒ€å | å½¹å‰² |
| ---- | ---- |
| config | è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ç®¡ç† |
| dokcer | dockerãƒ•ã‚¡ã‚¤ãƒ«ç®¡ç† |
| img | README.mdã§ä½¿ç”¨ã™ã‚‹ç”»åƒ |
| src | ros2è‡ªä½œãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ç®¡ç† |
| volume | dockerã®æ°¸ç¶šåŒ–ãƒ‡ãƒ¼ã‚¿ä¿å­˜ç”¨ |


# 3. WSL2ç’°å¢ƒè¨­å®š

0. **realsenseãŒPCã«æ¥ç¶šã•ã‚Œã¦ã„ãªã„ã“ã¨ã‚’ç¢ºèª**

1. **librealsenseã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’ã‚¯ãƒ­ãƒ¼ãƒ³**

```shell
$ git clone https://github.com/IntelRealSense/librealsense && cd librealsense
```
2. **udevãƒ«ãƒ¼ãƒ«ã®å¤‰æ›´**

```shell
$ sudo chmod +x ./scripts/setup_udev_rules.sh
$ ./scripts/setup_udev_rules.sh
```

3. **realsenseæ¥ç¶šå…ˆã®ç¢ºèª**
```shell
$ v4l2-ctl --list-devices

----------- ä»¥ä¸‹ã®ã‚ˆã†ãªå‡ºåŠ›ãªã‚‰OK --------------
Intel(R) RealSense(TM) Depth Ca (usb-0000:00:14.0-2):
	/dev/video4
	/dev/video5
	/dev/video6
	/dev/video7
	/dev/video8
	/dev/video9
	/dev/media2
	/dev/media3

 HD Webcam: HD Webcam (usb-0000:00:14.0-6):
	/dev/video0
	/dev/video1
	/dev/video2
	/dev/video3
	/dev/media0
	/dev/media1
------------------------------------------------
```

4. **docker-compose.yamlã®ä¿®æ­£**
ãƒ›ã‚¹ãƒˆPCä¸Šã®ãƒ‡ãƒã‚¤ã‚¹å‰²ã‚Šå½“ã¦ã‚’dockerã‚³ãƒ³ãƒ†ãƒŠã«ã‚‚åæ˜ ã•ã›ã‚‹ãŸã‚ã«ï¼Œ`docker-compose.yaml`ã‚’ä¿®æ­£ã™ã‚‹ï¼

**step1 ä¸Šè¨˜ã‚³ãƒãƒ³ãƒ‰ã®å‡ºåŠ›çµæœã‚’ç¢ºèªã™ã‚‹**
**step2 `docker-compose.yaml`ã®`devices`å±æ€§ã‚’ç¢ºèª**
**step3 å…¨ã¦ã®å‰²ã‚Šå½“ã¦ãŒè¨˜è¿°ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª**
**step4 è¨˜è¿°æ¼ã‚ŒãŒã‚ã‚Œã°è¿½åŠ ã™ã‚‹**

```shell:ä¾‹.sh
(ä¸Šè¨˜ã®å ´åˆã“ã®çŠ¶æ…‹ãªã‚‰å•é¡Œãªã„ï¼‰
    devices:
      - /dev/video0:/dev/video0
      - /dev/video1:/dev/video1
      - /dev/video2:/dev/video2
      - /dev/video3:/dev/video3
      - /dev/video4:/dev/video4
      - /dev/video5:/dev/video5
      - /dev/video6:/dev/video6
      - /dev/video7:/dev/video7
      - /dev/video8:/dev/video8
      - /dev/video9:/dev/video9
      - /dev/media2:/dev/media0
      - /dev/media3:/dev/media1
      - /dev/media2:/dev/media2
      - /dev/media3:/dev/media3
```


# 4. Dockerã‚³ãƒ³ãƒ†ãƒŠã®æ“ä½œ

1.  **dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã®ãƒ“ãƒ«ãƒ‰**

```shell
$ docker build --build-arg ROS_DISTRO=humble -t realsense-ros2-humble .
```

2.  **dockerã‚³ãƒ³ãƒ†ãƒŠã®ç«‹ã¡ä¸Šã’**

```shell
docker compose up -d
```

3. **dockerã‚³ãƒ³ãƒ†ãƒŠã®çµ‚äº†**
**ä½œæ¥­ãŒçµ‚ã‚ã‚Šã‚³ãƒ³ãƒ†ãƒŠã‚’çµ‚äº†ã™ã‚‹å ´åˆ**ã¯ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ï¼

```shell
docker compose down
```

# 5. ãƒ‡ãƒ¼ã‚¿åé›†

## 5.1 å‰æº–å‚™

1. **è¨˜æ†¶åª’ä½“ã®ç”¨æ„**
å‡ºåŠ›ã•ã‚Œã‚‹bagãƒ•ã‚¡ã‚¤ãƒ«ã¯éå¸¸ã«å¤§ãããªã‚‹ãŸã‚ï¼ˆæ•°åç§’ã®è¨˜éŒ²ã§1-2GBã»ã©ï¼‰USBï¼ŒSSDãªã©åˆ¥é€”è¨˜æ†¶åª’ä½“ã‚’ç”¨æ„ã™ã‚‹

2. **è¨˜éŒ²ä¿å­˜å…ˆã®ç¢ºèª**
`docker-compose.yaml`ã‚’é–‹ã`volumes`å±æ€§ã‚’ç¢ºèª
```shell
    volumes:
      - /tmp/.X11-unix:/tmp/.X11-unix
      - ./src:/ros2_ws/src
      - ./volume/bag:../bag <- ###ã“ã‚ŒãŒè¨˜éŒ²ä¿å­˜å…ˆ ï¼ˆãƒ›ã‚¹ãƒˆOSå´ãƒ•ã‚©ãƒ«ãƒ€:dockerå´ãƒ•ã‚©ãƒ«ãƒ€ï¼‰###
```

3. **volumeã®å¤‰æ›´**
ä»¥ä¸‹ã‚’é©åˆ‡ã«å¤‰æ›´ã—ã¦è¨˜éŒ²å…ˆã‚’å¤‰æ›´ã™ã‚‹

```shell
ä¾‹ï¼šD:/data/bagã«ä¿å­˜ã™ã‚‹å ´åˆ
    volumes:
      - /tmp/.X11-unix:/tmp/.X11-unix
      - ./src:/ros2_ws/src
      - D:/data/bag:../bag
```

## 5.2 ãƒ‡ãƒ¼ã‚¿åé›†æ‰‹é †

1. **ã‚³ãƒ³ãƒ†ãƒŠã®ã‚¢ã‚¿ãƒƒãƒ**
[7. Dockerã‚³ãƒ³ãƒ†ãƒŠã§ã®ä½œæ¥­æ‰‹é †](#7-dockerã‚³ãƒ³ãƒ†ãƒŠã§ã®ä½œæ¥­æ‰‹é †)ã«å¾“ã£ã¦ã‚³ãƒ³ãƒ†ãƒŠã®ã‚¢ã‚¿ãƒƒãƒã¾ã§è¡Œã†

2. **Realsense D435iã®æ¥ç¶šã‚’ç¢ºèª**
ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§Realsense D435iãŒæ¥ç¶šã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹ï¼

```shell
$ v4l2-ctl --list-device
Intel(R) RealSense(TM) Depth Ca (usb-0000:00:14.0-2):
	/dev/video2
	/dev/video3
	/dev/video4
	/dev/video5
	/dev/video6
	/dev/video7

Integrated_Webcam_HD: Integrate (usb-0000:00:14.0-5):
	/dev/video0
	/dev/video1
```

3. **ãƒ‡ãƒ¼ã‚¿åé›†ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®å®Ÿè¡Œ**
`output_filename`ã§å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«åã‚’å¤‰æ›´ã™ã‚‹ï¼
```shell
###############

output_filename = "sample1.bag"ã€€<- sample1.bagãŒä¿å­˜ã•ã‚Œã‚‹

###############
```
ä¸‹è¨˜ã‚³ãƒãƒ³ãƒ‰ã§ãƒ‡ãƒ¼ã‚¿åé›†ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’å®Ÿè¡Œã™ã‚‹ï¼

```shell
ros2 launch rtab_realsense 1_record_realsense.launch.py
```

4. **åé›†ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®çµ‚äº†**

ãƒ‡ãƒ¼ã‚¿åé›†ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã¯`Ctrl + C`ã§çµ‚äº†ã™ã‚‹ï¼

# 6. è»Œè·¡ã®è¨˜éŒ²ã¨å¯è¦–åŒ–

1. **è»Œè·¡ã®è¨˜éŒ²**
ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã«ã‚ˆã£ã¦ã—SLAMã‚’å®Ÿè¡Œã™ã‚‹ï¼

```shell
ros2 launch rtab_realsense 2_rtabmap_realsense.launch.py
```

åˆ¥ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‚’é–‹ã„ã¦ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ï¼
```shell
ros2 launch rtab_realsense 3_record_rtabmap.launch.py
```

2. **è»Œè·¡ã®å¯è¦–åŒ–**
`bag_file_path`ã‚’å¤‰æ›´ã—ã¦å¯è¦–åŒ–ã™ã‚‹bagãƒ•ã‚¡ã‚¤ãƒ«ã‚’æŒ‡å®šã™ã‚‹ï¼
```shell
###############
bag_file_path = 'sample1.bag'
###############
```

ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã¨rvizä¸Šã«realsenseã®ãƒãƒ¼ã‚ºãŒè¡¨ç¤ºã•ã‚Œã‚‹ï¼
```shell
ros2 launch rtab_realsense 4_play_bag.launch.py
```

# 7. VSCodeè¨­å®š

## 7.1 WSLã«æ¥ç¶š

- â‘ ç”»é¢å·¦ä¸‹ã®ã‚¢ã‚¤ã‚³ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
- â‘¡`Connect to WSL`ã‚’é¸æŠã—ï¼Œãƒªãƒ¢ãƒ¼ãƒˆã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’é–‹ã

![img](./img/VSCODEã§WSLã‚’é¸æŠ.jpg)

## 7.2 Dockerã‚³ãƒ³ãƒ†ãƒŠã‚’ã‚¢ã‚¿ãƒƒãƒ

1. ã‚³ãƒ³ãƒ†ãƒŠã‚’èµ·å‹•
- â‘ Dockeræ‹¡å¼µæ©Ÿèƒ½ã‚’é¸æŠ
- â‘¡èµ·å‹•ã—ãŸã„ã‚³ãƒ³ãƒ†ãƒŠã‚’å³ã‚¯ãƒªãƒƒã‚¯ã—`Start`ã‚’é¸æŠ
![img](./img/Dockerã‚³ãƒ³ãƒ†ãƒŠã‚’èµ·å‹•.png)


2. ã‚³ãƒ³ãƒ†ãƒŠã‚’VScodeã«ã‚¢ã‚¿ãƒƒãƒ
- â‘ ã‚³ãƒ³ãƒ†ãƒŠã®ãƒãƒ¼ã‚¯ãŒç·‘ã«ãªã‚Šèµ·å‹•çŠ¶æ…‹ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèª
- â‘¡`Attach Visual Studio Code`ã‚’é¸æŠã—ã‚³ãƒ³ãƒ†ãƒŠã‚’ã‚¢ã‚¿ãƒƒãƒ
![img](./img/Dockerã‚³ãƒ³ãƒ†ãƒŠã‚’VScodeã«ã‚¢ã‚¿ãƒƒãƒ.jpg)

## 7.3 ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é–‹ã

- â‘ é–‹ã„ãŸã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã®`File`ã‚’é¸æŠ
- â‘¡`Open Folder...`ã‚’é¸æŠã—ï¼Œãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’æ ¼ç´ã—ã¦ã„ã‚‹ä½œæ¥­ãƒ•ã‚©ãƒ«ãƒ€ã‚’é–‹ã

![img](./img/ä½œæ¥­ãƒ•ã‚©ãƒ«ãƒ€ã‚’é–‹ã.jpg)

# âœ…TODO

- [x] ãƒ—ãƒ­ã‚°ãƒ©ãƒ `3_***`ã¨`4_***`ã«é–¢ã™ã‚‹èª¬æ˜ã®è¿½è¨˜
- [ ] dockerã‚³ãƒ³ãƒ†ãƒŠã‹ã‚‰realsenseãŒæ“ä½œå¯èƒ½ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèª
- [ ] ros2ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ãƒ“ãƒ«ãƒ‰ã‚’ç¢ºèª
- [ ] rtabmapã®æ­£å¸¸å®Ÿè¡Œã‚’ç¢ºèª
- [ ] bagãƒ•ã‚¡ã‚¤ãƒ«ã®å®¹é‡ã‚’ç¢ºèªï¼ˆæ¨å¥¨ä¿å­˜å®¹é‡ã®ç¢ºèªã®ãŸã‚ï¼‰
- [x] VSCODEä¸Šã§ã®ã‚³ãƒ³ãƒ†ãƒŠæ“ä½œèª¬æ˜ã‚’è¿½è¨˜

# ğŸ“’å‚è€ƒæ–‡çŒ®
- [ROS 2ç’°å¢ƒã§RealSense D435ã‚’ä½¿ã£ã¦RTAB-MAPã‚’å‹•ã‹ã™](https://qiita.com/porizou1/items/1a2ca3a80c72a25289c9)
- [rtabmap](http://wiki.ros.org/rtabmap)
